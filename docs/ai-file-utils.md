# AI File Utils

The `ai_file_utils` module serves as a centralized "contract" and utility service for defining and resolving actions related to AI artifacts. It allows you to separate the *definition* of actions (like "View Markdown", "Open in ChatGPT") from the *implementation* in the UI.

This is not a standalone MkDocs plugin but a shared library that other plugins (like `resolve_md`, `ai_file_actions`, and `ai_resources_page`) can import to resolve action lists and generate the split-button dropdown HTML for any documentation page.

## ðŸ”¹ Usage

Since this is a helper library, you do not need to add it to your `mkdocs.yml` plugins list.

### Using in Python Code

Import the utility class directly in your code.

**`resolve_actions`** takes page context and returns a list of fully resolved action objects:

```python
from plugins.ai_file_utils.ai_file_utils import AIFileUtils

utils = AIFileUtils()

actions = utils.resolve_actions(
    page_url="https://docs.example.com/ai/pages/my-page.md",
    filename="my-page.md",
    content="# My Page Content..."
)
```

**`generate_dropdown_html`** renders the split-button dropdown component:

```python
from plugins.ai_file_utils.ai_file_utils import AIFileUtils

utils = AIFileUtils()

html = utils.generate_dropdown_html(
    url="/ai/pages/my-page.md",
    filename="my-page.md",
    exclude=["view-markdown"],  # optional
    primary_label="Copy page",  # optional
)
```

**Parameters:**

- `url` (str): The URL of the file to act upon.
- `filename` (str): The filename for the download action.
- `exclude` (list | None, optional): Action IDs to exclude from the dropdown. Defaults to `None` (all actions shown).
- `primary_label` (str | None, optional): Override the primary button's label. Defaults to `None` (uses the label from JSON, e.g., "Copy file").

**Returns:** An HTML string containing the split-button dropdown. The action marked `primary: true` in the JSON renders as the left-side button; all other actions render as dropdown items.

### Slug and URL Helpers

Static methods for building slugs and AI page URLs. These mirror the logic in `resolve_md.compute_slug_and_url` and the client-side `buildSlugFromPath`.

```python
slug = AIFileUtils.build_slug("develop/toolkit/")
# => "develop-toolkit"

slug = AIFileUtils.build_toggle_slug("develop/toolkit/", "python")
# => "develop-python"

url = AIFileUtils.build_ai_page_url("develop-toolkit")
# => "/ai/pages/develop-toolkit.md"
```

### Page Exclusion

The `is_page_excluded` method checks whether a page should be excluded from widget injection, based on the `pageWidget` configuration in `ai_file_actions.json`.

```python
excluded = utils.is_page_excluded(page.file.src_path, page.meta)
```

## Page Widget Configuration

The `pageWidget` section of `ai_file_actions.json` controls which pages are excluded from per-page widget injection.

```json
{
  "pageWidget": {
    "excludePages": ["404.html", "ai-resources.md"],
    "frontMatterKey": "hide_ai_actions"
  }
}
```

| Field | Type | Description |
| :--- | :--- | :--- |
| `excludePages` | `list[str]` | Page source paths (exact match or suffix match) to exclude from widget injection. |
| `frontMatterKey` | `string` | Front matter key that, when truthy, excludes a page from widget injection. |

## Action Model

The core of this module is the **Action Model**, defined in `ai_file_actions.json`. This JSON schema defines what actions are available and how they behave.

### Schema Fields

| Field | Type | Description |
| :--- | :--- | :--- |
| `type` | `string` | The category of action. Currently supports `link` (navigation) and `clipboard` (copy text). |
| `id` | `string` | Unique identifier (e.g., `view-markdown`, `open-chat-gpt`). |
| `label` | `string` | The human-readable text displayed in the UI. |
| `analyticsKey` | `string` | A standardized key for tracking usage events. |
| `href` | `string` | (Link only) The destination URL. Supports interpolation. |
| `download` | `string` | (Link only) If present, triggers a file download with this filename. |
| `clipboardContent` | `string` | (Clipboard only) The text to be copied. |
| `promptTemplate` | `string` | (LLM only) A template used to generate the `{{ prompt }}` variable. |
| `icon` | `string` | Inline SVG markup for the action's icon. |
| `trailingIcon` | `string` | Inline SVG markup rendered after the label (e.g., external-link arrow). |
| `primary` | `boolean` | If `true`, renders as the left-side button instead of a dropdown item. |

### Interpolation Variables

The module supports dynamic injection of context using `{{ variable }}` syntax.

| Variable | Description |
| :--- | :--- |
| `{{ page_url }}` | The full URL to the resolved AI artifact (the markdown file). |
| `{{ filename }}` | The filename of the markdown file (e.g., `basics.md`). |
| `{{ content }}` | The full text content of the markdown file. |
| `{{ prompt }}` | A special variable generated by processing the `promptTemplate` and URL-encoding the result. |

## ðŸ”¹ Adding New Actions

To add a new action (e.g., "Open in Gemini"), you modify `plugins/ai_file_utils/ai_file_actions.json`. You do not need to write new Python code.

### Example: Adding a New LLM

```json
{
  "type": "link",
  "id": "open-gemini",
  "label": "Open in Gemini",
  "href": "https://gemini.google.com/app?q={{ prompt }}",
  "promptTemplate": "Read {{ page_url }} and explain it to me.",
  "analyticsKey": "open_page_markdown_gemini"
}
```

This configuration will automatically:
1.  Resolve `{{ page_url }}` in the prompt template.
2.  URL-encode the result into `{{ prompt }}`.
3.  Inject it into the `href`.
